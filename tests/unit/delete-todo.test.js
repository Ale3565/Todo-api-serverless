"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Set up environment first
process.env.NODE_ENV = 'test';
process.env.TABLE_NAME = 'TestTodos';
// Mock the DynamoDB and CloudWatch utilities
jest.mock('../../src/lambda/utils/dynamodb');
jest.mock('../../src/lambda/utils/cloudwatch');
const delete_todo_1 = require("../../src/lambda/handlers/delete-todo");
const dynamodb_1 = require("../../src/lambda/utils/dynamodb");
const cloudwatch_1 = require("../../src/lambda/utils/cloudwatch");
// Get mocked instances
const mockDynamoDb = dynamodb_1.dynamoDb;
const mockPublishMetric = cloudwatch_1.publishMetric;
describe('delete-todo handler', () => {
    beforeEach(() => {
        // Reset all mocks
        jest.clearAllMocks();
        // Set up default mock behaviors
        mockPublishMetric.mockResolvedValue(undefined);
    });
    it('should delete todo successfully', async () => {
        // Configure mock for successful deletion
        mockDynamoDb.send.mockResolvedValueOnce({});
        const event = {
            pathParameters: { id: '123' },
            httpMethod: 'DELETE',
            path: '/todos/123'
        };
        const result = await (0, delete_todo_1.handler)(event);
        expect(result.statusCode).toBe(204);
        expect(result.body).toBe('');
        expect(mockDynamoDb.send).toHaveBeenCalledTimes(1);
        expect(mockPublishMetric).toHaveBeenCalledWith('TodoDeletedCount', 1);
    });
    it('should return 400 when id parameter is missing', async () => {
        const event = {
            pathParameters: null,
            httpMethod: 'DELETE',
            path: '/todos/123'
        };
        const result = await (0, delete_todo_1.handler)(event);
        expect(result.statusCode).toBe(400);
        expect(JSON.parse(result.body).error).toBe('MISSING_ID');
        expect(mockDynamoDb.send).not.toHaveBeenCalled();
    });
    it('should return 404 when todo not found', async () => {
        // Configure mock to simulate conditional check failure
        const conditionalError = new Error('The conditional request failed');
        conditionalError.name = 'ConditionalCheckFailedException';
        mockDynamoDb.send.mockRejectedValueOnce(conditionalError);
        const event = {
            pathParameters: { id: '999' },
            httpMethod: 'DELETE',
            path: '/todos/999'
        };
        const result = await (0, delete_todo_1.handler)(event);
        expect(result.statusCode).toBe(404);
        expect(JSON.parse(result.body).error).toBe('TODO_NOT_FOUND');
        expect(mockDynamoDb.send).toHaveBeenCalledTimes(1);
    });
    it('should handle DynamoDB errors', async () => {
        // Configure mock to simulate general DynamoDB error
        mockDynamoDb.send.mockRejectedValueOnce(new Error('DynamoDB Error'));
        const event = {
            pathParameters: { id: '123' },
            httpMethod: 'DELETE',
            path: '/todos/123'
        };
        const result = await (0, delete_todo_1.handler)(event);
        expect(result.statusCode).toBe(500);
        expect(JSON.parse(result.body).error).toBe('DB_ERROR');
        expect(mockDynamoDb.send).toHaveBeenCalledTimes(1);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsZXRlLXRvZG8udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRlbGV0ZS10b2RvLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQkFBMkI7QUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDO0FBQzlCLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQztBQUVyQyw2Q0FBNkM7QUFDN0MsSUFBSSxDQUFDLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQzdDLElBQUksQ0FBQyxJQUFJLENBQUMsbUNBQW1DLENBQUMsQ0FBQztBQUcvQyx1RUFBZ0U7QUFDaEUsOERBQTJEO0FBQzNELGtFQUFrRTtBQUVsRSx1QkFBdUI7QUFDdkIsTUFBTSxZQUFZLEdBQUcsbUJBQXdDLENBQUM7QUFDOUQsTUFBTSxpQkFBaUIsR0FBRywwQkFBMEQsQ0FBQztBQUVyRixRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO0lBQ25DLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxrQkFBa0I7UUFDbEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLGdDQUFnQztRQUNoQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxpQ0FBaUMsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMvQyx5Q0FBeUM7UUFDekMsWUFBWSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUU1QyxNQUFNLEtBQUssR0FBa0M7WUFDM0MsY0FBYyxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRTtZQUM3QixVQUFVLEVBQUUsUUFBUTtZQUNwQixJQUFJLEVBQUUsWUFBWTtTQUNuQixDQUFDO1FBRUYsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLHFCQUFPLEVBQUMsS0FBNkIsQ0FB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QyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdkQsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyRCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU2V0IHVwIGVudmlyb25tZW50IGZpcnN0XHJcbnByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnO1xyXG5wcm9jZXNzLmVudi5UQUJMRV9OQU1FID0gJ1Rlc3RUb2Rvcyc7XHJcblxyXG4vLyBNb2NrIHRoZSBEeW5hbW9EQiBhbmQgQ2xvdWRXYXRjaCB1dGlsaXRpZXNcclxuamVzdC5tb2NrKCcuLi8uLi9zcmMvbGFtYmRhL3V0aWxzL2R5bmFtb2RiJyk7XHJcbmplc3QubW9jaygnLi4vLi4vc3JjL2xhbWJkYS91dGlscy9jbG91ZHdhdGNoJyk7XHJcblxyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBoYW5kbGVyIH0gZnJvbSAnLi4vLi4vc3JjL2xhbWJkYS9oYW5kbGVycy9kZWxldGUtdG9kbyc7XHJcbmltcG9ydCB7IGR5bmFtb0RiIH0gZnJvbSAnLi4vLi4vc3JjL2xhbWJkYS91dGlscy9keW5hbW9kYic7XHJcbmltcG9ydCB7IHB1Ymxpc2hNZXRyaWMgfSBmcm9tICcuLi8uLi9zcmMvbGFtYmRhL3V0aWxzL2Nsb3Vkd2F0Y2gnO1xyXG5cclxuLy8gR2V0IG1vY2tlZCBpbnN0YW5jZXNcclxuY29uc3QgbW9ja0R5bmFtb0RiID0gZHluYW1vRGIgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGR5bmFtb0RiPjtcclxuY29uc3QgbW9ja1B1Ymxpc2hNZXRyaWMgPSBwdWJsaXNoTWV0cmljIGFzIGplc3QuTW9ja2VkRnVuY3Rpb248dHlwZW9mIHB1Ymxpc2hNZXRyaWM+O1xyXG5cclxuZGVzY3JpYmUoJ2RlbGV0ZS10b2RvIGhhbmRsZXInLCAoKSA9PiB7XHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICAvLyBSZXNldCBhbGwgbW9ja3NcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gICAgXHJcbiAgICAvLyBTZXQgdXAgZGVmYXVsdCBtb2NrIGJlaGF2aW9yc1xyXG4gICAgbW9ja1B1Ymxpc2hNZXRyaWMubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBkZWxldGUgdG9kbyBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAvLyBDb25maWd1cmUgbW9jayBmb3Igc3VjY2Vzc2Z1bCBkZWxldGlvblxyXG4gICAgbW9ja0R5bmFtb0RiLnNlbmQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHt9KTtcclxuXHJcbiAgICBjb25zdCBldmVudDogUGFydGlhbDxBUElHYXRld2F5UHJveHlFdmVudD4gPSB7XHJcbiAgICAgIHBhdGhQYXJhbWV0ZXJzOiB7IGlkOiAnMTIzJyB9LFxyXG4gICAgICBodHRwTWV0aG9kOiAnREVMRVRFJyxcclxuICAgICAgcGF0aDogJy90b2Rvcy8xMjMnXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQgYXMgQVBJR2F0ZXdheVByb3h5RXZlbnQpO1xyXG5cclxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSgyMDQpO1xyXG4gICAgZXhwZWN0KHJlc3VsdC5ib2R5KS50b0JlKCcnKTtcclxuICAgIGV4cGVjdChtb2NrRHluYW1vRGIuc2VuZCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xyXG4gICAgZXhwZWN0KG1vY2tQdWJsaXNoTWV0cmljKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnVG9kb0RlbGV0ZWRDb3VudCcsIDEpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIHJldHVybiA0MDAgd2hlbiBpZCBwYXJhbWV0ZXIgaXMgbWlzc2luZycsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IGV2ZW50OiBQYXJ0aWFsPEFQSUdhdGV3YXlQcm94eUV2ZW50PiA9IHtcclxuICAgICAgcGF0aFBhcmFtZXRlcnM6IG51bGwsXHJcbiAgICAgIGh0dHBNZXRob2Q6ICdERUxFVEUnLFxyXG4gICAgICBwYXRoOiAnL3RvZG9zLzEyMydcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCBhcyBBUElHYXRld2F5UHJveHlFdmVudCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XHJcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkuZXJyb3IpLnRvQmUoJ01JU1NJTkdfSUQnKTtcclxuICAgIGV4cGVjdChtb2NrRHluYW1vRGIuc2VuZCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCByZXR1cm4gNDA0IHdoZW4gdG9kbyBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAvLyBDb25maWd1cmUgbW9jayB0byBzaW11bGF0ZSBjb25kaXRpb25hbCBjaGVjayBmYWlsdXJlXHJcbiAgICBjb25zdCBjb25kaXRpb25hbEVycm9yID0gbmV3IEVycm9yKCdUaGUgY29uZGl0aW9uYWwgcmVxdWVzdCBmYWlsZWQnKTtcclxuICAgIGNvbmRpdGlvbmFsRXJyb3IubmFtZSA9ICdDb25kaXRpb25hbENoZWNrRmFpbGVkRXhjZXB0aW9uJztcclxuICAgIG1vY2tEeW5hbW9EYi5zZW5kLm1vY2tSZWplY3RlZFZhbHVlT25jZShjb25kaXRpb25hbEVycm9yKTtcclxuXHJcbiAgICBjb25zdCBldmVudDogUGFydGlhbDxBUElHYXRld2F5UHJveHlFdmVudD4gPSB7XHJcbiAgICAgIHBhdGhQYXJhbWV0ZXJzOiB7IGlkOiAnOTk5JyB9LFxyXG4gICAgICBodHRwTWV0aG9kOiAnREVMRVRFJyxcclxuICAgICAgcGF0aDogJy90b2Rvcy85OTknXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQgYXMgQVBJR2F0ZXdheVByb3h5RXZlbnQpO1xyXG5cclxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDQpO1xyXG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpLmVycm9yKS50b0JlKCdUT0RPX05PVF9GT1VORCcpO1xyXG4gICAgZXhwZWN0KG1vY2tEeW5hbW9EYi5zZW5kKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgaGFuZGxlIER5bmFtb0RCIGVycm9ycycsIGFzeW5jICgpID0+IHtcclxuICAgIC8vIENvbmZpZ3VyZSBtb2NrIHRvIHNpbXVsYXRlIGdlbmVyYWwgRHluYW1vREIgZXJyb3JcclxuICAgIG1vY2tEeW5hbW9EYi5zZW5kLm1vY2tSZWplY3RlZFZhbHVlT25jZShuZXcgRXJyb3IoJ0R5bmFtb0RCIEVycm9yJykpO1xyXG5cclxuICAgIGNvbnN0IGV2ZW50OiBQYXJ0aWFsPEFQSUdhdGV3YXlQcm94eUV2ZW50PiA9IHtcclxuICAgICAgcGF0aFBhcmFtZXRlcnM6IHsgaWQ6ICcxMjMnIH0sXHJcbiAgICAgIGh0dHBNZXRob2Q6ICdERUxFVEUnLFxyXG4gICAgICBwYXRoOiAnL3RvZG9zLzEyMydcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCBhcyBBUElHYXRld2F5UHJveHlFdmVudCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDUwMCk7XHJcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkuZXJyb3IpLnRvQmUoJ0RCX0VSUk9SJyk7XHJcbiAgICBleHBlY3QobW9ja0R5bmFtb0RiLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcclxuICB9KTtcclxufSk7Il19