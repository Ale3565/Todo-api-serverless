"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_client_mock_1 = require("aws-sdk-client-mock");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_cloudwatch_1 = require("@aws-sdk/client-cloudwatch");
const update_todo_1 = require("../../src/lambda/handlers/update-todo");
const ddbMock = (0, aws_sdk_client_mock_1.mockClient)(lib_dynamodb_1.DynamoDBDocumentClient);
const cloudWatchMock = (0, aws_sdk_client_mock_1.mockClient)(client_cloudwatch_1.CloudWatchClient);
describe('update-todo handler', () => {
    beforeEach(() => {
        ddbMock.reset();
        cloudWatchMock.reset();
        cloudWatchMock.on(client_cloudwatch_1.PutMetricDataCommand).resolves({});
    });
    it('should update todo successfully', async () => {
        const updatedTodo = {
            todoId: '123',
            title: 'Updated Todo',
            completed: true,
            updatedAt: '2025-01-01T00:00:00.000Z'
        };
        ddbMock.on(lib_dynamodb_1.UpdateCommand).resolves({ Attributes: updatedTodo });
        const event = {
            pathParameters: { id: '123' },
            body: JSON.stringify({ title: 'Updated Todo', completed: true }),
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(200);
        expect(JSON.parse(result.body).success).toBe(true);
        expect(JSON.parse(result.body).data.title).toBe('Updated Todo');
        expect(ddbMock.commandCalls(lib_dynamodb_1.UpdateCommand).length).toBe(1);
    });
    it('should return 400 when id parameter is missing', async () => {
        const event = {
            pathParameters: null,
            body: JSON.stringify({ title: 'Updated Todo' }),
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(400);
        expect(JSON.parse(result.body).error).toBe('MISSING_ID');
    });
    it('should return 400 when body is missing', async () => {
        const event = {
            pathParameters: { id: '123' },
            body: null,
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(400);
        expect(JSON.parse(result.body).error).toBe('MISSING_BODY');
    });
    it('should return 400 when body is invalid JSON', async () => {
        const event = {
            pathParameters: { id: '123' },
            body: 'invalid json',
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(400);
        expect(JSON.parse(result.body).error).toBe('INVALID_JSON');
    });
    it('should return 400 when no valid fields to update', async () => {
        const event = {
            pathParameters: { id: '123' },
            body: JSON.stringify({}),
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(400);
        expect(JSON.parse(result.body).error).toBe('NO_UPDATES');
    });
    it('should return 400 when title is empty string', async () => {
        const event = {
            pathParameters: { id: '123' },
            body: JSON.stringify({ title: '' }),
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(400);
        expect(JSON.parse(result.body).error).toBe('INVALID_TITLE');
    });
    it('should return 400 when completed is not boolean', async () => {
        const event = {
            pathParameters: { id: '123' },
            body: JSON.stringify({ completed: 'true' }),
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(400);
        expect(JSON.parse(result.body).error).toBe('INVALID_COMPLETED');
    });
    it('should return 404 when todo not found', async () => {
        const conditionalError = new Error('The conditional request failed');
        conditionalError.name = 'ConditionalCheckFailedException';
        ddbMock.on(lib_dynamodb_1.UpdateCommand).rejects(conditionalError);
        const event = {
            pathParameters: { id: '999' },
            body: JSON.stringify({ title: 'Updated Todo' }),
            httpMethod: 'PUT',
            path: '/todos/999'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(404);
        expect(JSON.parse(result.body).error).toBe('NOT_FOUND');
    });
    it('should handle DynamoDB errors', async () => {
        ddbMock.on(lib_dynamodb_1.UpdateCommand).rejects(new Error('DynamoDB Error'));
        const event = {
            pathParameters: { id: '123' },
            body: JSON.stringify({ title: 'Updated Todo' }),
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(500);
        expect(JSON.parse(result.body).error).toBe('INTERNAL_ERROR');
    });
    it('should update only description', async () => {
        const updatedTodo = {
            todoId: '123',
            description: 'New description',
            updatedAt: '2025-01-01T00:00:00.000Z'
        };
        ddbMock.on(lib_dynamodb_1.UpdateCommand).resolves({ Attributes: updatedTodo });
        const event = {
            pathParameters: { id: '123' },
            body: JSON.stringify({ description: 'New description' }),
            httpMethod: 'PUT',
            path: '/todos/123'
        };
        const result = await (0, update_todo_1.handler)(event);
        expect(result.statusCode).toBe(200);
        expect(JSON.parse(result.body).success).toBe(true);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXRvZG8udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInVwZGF0ZS10b2RvLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSw2REFBaUQ7QUFDakQsd0RBQThFO0FBQzlFLGtFQUFvRjtBQUVwRix1RUFBZ0U7QUFFaEUsTUFBTSxPQUFPLEdBQUcsSUFBQSxnQ0FBVSxFQUFDLHFDQUFzQixDQUFDLENBQUM7QUFDbkQsTUFBTSxjQUFjLEdBQUcsSUFBQSxnQ0FBVSxFQUFDLG9DQUFnQixDQUFDLENBQUM7QUFFcEQsUUFBUSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtJQUNuQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2hCLGNBQWMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUd2QixjQUFjLENBQUMsRUFBRSxDQUFDLHdDQUFvQixDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZELENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLGlDQUFpQyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQy9DLE1BQU0sV0FBVyxHQUFHO1lBQ2xCLE1BQU0sRUFBRSxLQUFLO1lBQ2IsS0FBSyxFQUFFLGNBQWM7WUFDckIsU0FBUyxFQUFFLElBQUk7WUFDZixTQUFTLEVBQUUsMEJBQTBCO1NBQ3RDLENBQUM7UUFFRixPQUFPLENBQUMsRUFBRSxDQUFDLDRCQUFhLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUVoRSxNQUFNLEtBQUssR0FBa0M7WUFDM0MsY0FBYyxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRTtZQUM3QixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDO1lBQ2hFLFVBQVUsRUFBRSxL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QztRQUVGLE9BQU8sQ0FBQyxFQUFFLENBQUMsNEJBQWEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBRWhFLE1BQU0sS0FBSyxHQUFrQztZQUMzQyxjQUFjLEVBQUUsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFO1lBQzdCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsV0FBVyxFQUFFLGlCQUFpQixFQUFFLENBQUM7WUFDeEQsVUFBVSxFQUFFLEtBQUs7WUFDakIsSUFBSSxFQUFFLFlBQVk7U0FDbkIsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxxQkFBTyxFQUFDLEtBQTZCLENBQUMsQ0FBQztRQUU1RCxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBtb2NrQ2xpZW50IH0gZnJvbSAnYXdzLXNkay1jbGllbnQtbW9jayc7XHJcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFVwZGF0ZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xyXG5pbXBvcnQgeyBDbG91ZFdhdGNoQ2xpZW50LCBQdXRNZXRyaWNEYXRhQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jbG91ZHdhdGNoJztcclxuXHJcbmltcG9ydCB7IGhhbmRsZXIgfSBmcm9tICcuLi8uLi9zcmMvbGFtYmRhL2hhbmRsZXJzL3VwZGF0ZS10b2RvJztcclxuXHJcbmNvbnN0IGRkYk1vY2sgPSBtb2NrQ2xpZW50KER5bmFtb0RCRG9jdW1lbnRDbGllbnQpO1xyXG5jb25zdCBjbG91ZFdhdGNoTW9jayA9IG1vY2tDbGllbnQoQ2xvdWRXYXRjaENsaWVudCk7XHJcblxyXG5kZXNjcmliZSgndXBkYXRlLXRvZG8gaGFuZGxlcicsICgpID0+IHtcclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGRkYk1vY2sucmVzZXQoKTtcclxuICAgIGNsb3VkV2F0Y2hNb2NrLnJlc2V0KCk7XHJcbiAgICBcclxuICAgIFxyXG4gICAgY2xvdWRXYXRjaE1vY2sub24oUHV0TWV0cmljRGF0YUNvbW1hbmQpLnJlc29sdmVzKHt9KTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCB1cGRhdGUgdG9kbyBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCB1cGRhdGVkVG9kbyA9IHtcclxuICAgICAgdG9kb0lkOiAnMTIzJyxcclxuICAgICAgdGl0bGU6ICdVcGRhdGVkIFRvZG8nLFxyXG4gICAgICBjb21wbGV0ZWQ6IHRydWUsXHJcbiAgICAgIHVwZGF0ZWRBdDogJzIwMjUtMDEtMDFUMDA6MDA6MDAuMDAwWidcclxuICAgIH07XHJcblxyXG4gICAgZGRiTW9jay5vbihVcGRhdGVDb21tYW5kKS5yZXNvbHZlcyh7IEF0dHJpYnV0ZXM6IHVwZGF0ZWRUb2RvIH0pO1xyXG5cclxuICAgIGNvbnN0IGV2ZW50OiBQYXJ0aWFsPEFQSUdhdGV3YXlQcm94eUV2ZW50PiA9IHtcclxuICAgICAgcGF0aFBhcmFtZXRlcnM6IHsgaWQ6ICcxMjMnIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgdGl0bGU6ICdVcGRhdGVkIFRvZG8nLCBjb21wbGV0ZWQ6IHRydWUgfSksXHJcbiAgICAgIGh0dHBNZXRob2Q6ICdQVVQnLFxyXG4gICAgICBwYXRoOiAnL3RvZG9zLzEyMydcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCBhcyBBUElHYXRld2F5UHJveHlFdmVudCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDIwMCk7XHJcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5KS5kYXRhLnRpdGxlKS50b0JlKCdVcGRhdGVkIFRvZG8nKTtcclxuICAgIGV4cGVjdChkZGJNb2NrLmNvbW1hbmRDYWxscyhVcGRhdGVDb21tYW5kKS5sZW5ndGgpLnRvQmUoMSk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgcmV0dXJuIDQwMCB3aGVuIGlkIHBhcmFtZXRlciBpcyBtaXNzaW5nJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgZXZlbnQ6IFBhcnRpYWw8QVBJR2F0ZXdheVByb3h5RXZlbnQ+ID0ge1xyXG4gICAgICBwYXRoUGFyYW1ldGVyczogbnVsbCxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyB0aXRsZTogJ1VwZGF0ZWQgVG9kbycgfSksXHJcbiAgICAgIGh0dHBNZXRob2Q6ICdQVVQnLFxyXG4gICAgICBwYXRoOiAnL3RvZG9zLzEyMydcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCBhcyBBUElHYXRld2F5UHJveHlFdmVudCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XHJcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkuZXJyb3IpLnRvQmUoJ01JU1NJTkdfSUQnKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCByZXR1cm4gNDAwIHdoZW4gYm9keSBpcyBtaXNzaW5nJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgZXZlbnQ6IFBhcnRpYWw8QVBJR2F0ZXdheVByb3h5RXZlbnQ+ID0ge1xyXG4gICAgICBwYXRoUGFyYW1ldGVyczogeyBpZDogJzEyMycgfSxcclxuICAgICAgYm9keTogbnVsbCxcclxuICAgICAgaHR0cE1ldGhvZDogJ1BVVCcsXHJcbiAgICAgIHBhdGg6ICcvdG9kb3MvMTIzJ1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50IGFzIEFQSUdhdGV3YXlQcm94eUV2ZW50KTtcclxuXHJcbiAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcclxuICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5KS5lcnJvcikudG9CZSgnTUlTU0lOR19CT0RZJyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgcmV0dXJuIDQwMCB3aGVuIGJvZHkgaXMgaW52YWxpZCBKU09OJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgZXZlbnQ6IFBhcnRpYWw8QVBJR2F0ZXdheVByb3h5RXZlbnQ+ID0ge1xyXG4gICAgICBwYXRoUGFyYW1ldGVyczogeyBpZDogJzEyMycgfSxcclxuICAgICAgYm9keTogJ2ludmFsaWQganNvbicsXHJcbiAgICAgIGh0dHBNZXRob2Q6ICdQVVQnLFxyXG4gICAgICBwYXRoOiAnL3RvZG9zLzEyMydcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCBhcyBBUElHYXRld2F5UHJveHlFdmVudCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XHJcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkuZXJyb3IpLnRvQmUoJ0lOVkFMSURfSlNPTicpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIHJldHVybiA0MDAgd2hlbiBubyB2YWxpZCBmaWVsZHMgdG8gdXBkYXRlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgZXZlbnQ6IFBhcnRpYWw8QVBJR2F0ZXdheVByb3h5RXZlbnQ+ID0ge1xyXG4gICAgICBwYXRoUGFyYW1ldGVyczogeyBpZDogJzEyMycgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe30pLFxyXG4gICAgICBodHRwTWV0aG9kOiAnUFVUJyxcclxuICAgICAgcGF0aDogJy90b2Rvcy8xMjMnXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQgYXMgQVBJR2F0ZXdheVByb3h5RXZlbnQpO1xyXG5cclxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xyXG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpLmVycm9yKS50b0JlKCdOT19VUERBVEVTJyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgcmV0dXJuIDQwMCB3aGVuIHRpdGxlIGlzIGVtcHR5IHN0cmluZycsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IGV2ZW50OiBQYXJ0aWFsPEFQSUdhdGV3YXlQcm94eUV2ZW50PiA9IHtcclxuICAgICAgcGF0aFBhcmFtZXRlcnM6IHsgaWQ6ICcxMjMnIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgdGl0bGU6ICcnIH0pLFxyXG4gICAgICBodHRwTWV0aG9kOiAnUFVUJyxcclxuICAgICAgcGF0aDogJy90b2Rvcy8xMjMnXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQgYXMgQVBJR2F0ZXdheVByb3h5RXZlbnQpO1xyXG5cclxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xyXG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpLmVycm9yKS50b0JlKCdJTlZBTElEX1RJVExFJyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgcmV0dXJuIDQwMCB3aGVuIGNvbXBsZXRlZCBpcyBub3QgYm9vbGVhbicsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IGV2ZW50OiBQYXJ0aWFsPEFQSUdhdGV3YXlQcm94eUV2ZW50PiA9IHtcclxuICAgICAgcGF0aFBhcmFtZXRlcnM6IHsgaWQ6ICcxMjMnIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgY29tcGxldGVkOiAndHJ1ZScgfSksXHJcbiAgICAgIGh0dHBNZXRob2Q6ICdQVVQnLFxyXG4gICAgICBwYXRoOiAnL3RvZG9zLzEyMydcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCBhcyBBUElHYXRld2F5UHJveHlFdmVudCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XHJcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkuZXJyb3IpLnRvQmUoJ0lOVkFMSURfQ09NUExFVEVEJyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgcmV0dXJuIDQwNCB3aGVuIHRvZG8gbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgXHJcbiAgICBjb25zdCBjb25kaXRpb25hbEVycm9yID0gbmV3IEVycm9yKCdUaGUgY29uZGl0aW9uYWwgcmVxdWVzdCBmYWlsZWQnKTtcclxuICAgIChjb25kaXRpb25hbEVycm9yIGFzIGFueSkubmFtZSA9ICdDb25kaXRpb25hbENoZWNrRmFpbGVkRXhjZXB0aW9uJztcclxuICAgIGRkYk1vY2sub24oVXBkYXRlQ29tbWFuZCkucmVqZWN0cyhjb25kaXRpb25hbEVycm9yKTtcclxuXHJcbiAgICBjb25zdCBldmVudDogUGFydGlhbDxBUElHYXRld2F5UHJveHlFdmVudD4gPSB7XHJcbiAgICAgIHBhdGhQYXJhbWV0ZXJzOiB7IGlkOiAnOTk5JyB9LFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHRpdGxlOiAnVXBkYXRlZCBUb2RvJyB9KSxcclxuICAgICAgaHR0cE1ldGhvZDogJ1BVVCcsXHJcbiAgICAgIHBhdGg6ICcvdG9kb3MvOTk5J1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50IGFzIEFQSUdhdGV3YXlQcm94eUV2ZW50KTtcclxuXHJcbiAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDA0KTtcclxuICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5KS5lcnJvcikudG9CZSgnTk9UX0ZPVU5EJyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgaGFuZGxlIER5bmFtb0RCIGVycm9ycycsIGFzeW5jICgpID0+IHtcclxuICAgIGRkYk1vY2sub24oVXBkYXRlQ29tbWFuZCkucmVqZWN0cyhuZXcgRXJyb3IoJ0R5bmFtb0RCIEVycm9yJykpO1xyXG5cclxuICAgIGNvbnN0IGV2ZW50OiBQYXJ0aWFsPEFQSUdhdGV3YXlQcm94eUV2ZW50PiA9IHtcclxuICAgICAgcGF0aFBhcmFtZXRlcnM6IHsgaWQ6ICcxMjMnIH0sXHJcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgdGl0bGU6ICdVcGRhdGVkIFRvZG8nIH0pLFxyXG4gICAgICBodHRwTWV0aG9kOiAnUFVUJyxcclxuICAgICAgcGF0aDogJy90b2Rvcy8xMjMnXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQgYXMgQVBJR2F0ZXdheVByb3h5RXZlbnQpO1xyXG5cclxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg1MDApO1xyXG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpLmVycm9yKS50b0JlKCdJTlRFUk5BTF9FUlJPUicpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIHVwZGF0ZSBvbmx5IGRlc2NyaXB0aW9uJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgdXBkYXRlZFRvZG8gPSB7XHJcbiAgICAgIHRvZG9JZDogJzEyMycsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiAnTmV3IGRlc2NyaXB0aW9uJyxcclxuICAgICAgdXBkYXRlZEF0OiAnMjAyNS0wMS0wMVQwMDowMDowMC4wMDBaJ1xyXG4gICAgfTtcclxuXHJcbiAgICBkZGJNb2NrLm9uKFVwZGF0ZUNvbW1hbmQpLnJlc29sdmVzKHsgQXR0cmlidXRlczogdXBkYXRlZFRvZG8gfSk7XHJcblxyXG4gICAgY29uc3QgZXZlbnQ6IFBhcnRpYWw8QVBJR2F0ZXdheVByb3h5RXZlbnQ+ID0ge1xyXG4gICAgICBwYXRoUGFyYW1ldGVyczogeyBpZDogJzEyMycgfSxcclxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBkZXNjcmlwdGlvbjogJ05ldyBkZXNjcmlwdGlvbicgfSksXHJcbiAgICAgIGh0dHBNZXRob2Q6ICdQVVQnLFxyXG4gICAgICBwYXRoOiAnL3RvZG9zLzEyMydcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCBhcyBBUElHYXRld2F5UHJveHlFdmVudCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDIwMCk7XHJcbiAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSkuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICB9KTtcclxufSk7Il19