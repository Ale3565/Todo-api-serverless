"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Set up environment first
process.env.NODE_ENV = 'test';
process.env.TABLE_NAME = 'TestTodos';
// Mock the DynamoDB and CloudWatch utilities
jest.mock('../../src/lambda/utils/dynamodb');
jest.mock('../../src/lambda/utils/cloudwatch');
const create_todo_1 = require("../../src/lambda/handlers/create-todo");
const dynamodb_1 = require("../../src/lambda/utils/dynamodb");
const cloudwatch_1 = require("../../src/lambda/utils/cloudwatch");
// Get mocked instances
const mockDynamoDb = dynamodb_1.dynamoDb;
const mockPublishMetric = cloudwatch_1.publishMetric;
describe('CreateTodo Lambda', () => {
    beforeEach(() => {
        // Reset all mocks
        jest.clearAllMocks();
        // Set up default mock behaviors
        mockPublishMetric.mockResolvedValue(undefined);
    });
    const mockEvent = {
        body: JSON.stringify({
            title: 'Test todo',
            description: 'Test description'
        }),
        headers: {},
        httpMethod: 'POST',
        path: '/todos',
        queryStringParameters: null,
        pathParameters: null,
        requestContext: {
            requestId: 'test-request-id'
        }
    };
    it('should create a todo successfully', async () => {
        mockDynamoDb.send.mockResolvedValueOnce({});
        const result = await (0, create_todo_1.handler)(mockEvent);
        expect(result.statusCode).toBe(201);
        const body = JSON.parse(result.body);
        console.log('Response body:', JSON.stringify(body, null, 2));
        console.log('Response data:', JSON.stringify(body.data, null, 2));
        expect(body.success).toBe(true);
        expect(body.data).toHaveProperty('id');
        expect(body.data).toHaveProperty('todoId');
        expect(body.data.title).toBe('Test todo');
        expect(body.data.description).toBe('Test description');
        expect(body.data).toHaveProperty('createdAt');
        expect(mockDynamoDb.send).toHaveBeenCalledTimes(1);
        expect(mockPublishMetric).toHaveBeenCalledWith('TodoCreatedCount', 1);
    });
    it('should return 400 for invalid input', async () => {
        const invalidEvent = {
            ...mockEvent,
            body: JSON.stringify({ title: '' })
        };
        const result = await (0, create_todo_1.handler)(invalidEvent);
        expect(result.statusCode).toBe(400);
        expect(JSON.parse(result.body)).toHaveProperty('message');
        expect(JSON.parse(result.body).error).toBe('INVALID_TITLE');
        expect(mockDynamoDb.send).not.toHaveBeenCalled();
        expect(mockPublishMetric).not.toHaveBeenCalled();
    });
    it('should handle DynamoDB errors', async () => {
        mockDynamoDb.send.mockRejectedValueOnce(new Error('DynamoDB error'));
        const result = await (0, create_todo_1.handler)(mockEvent);
        expect(result.statusCode).toBe(500);
        const body = JSON.parse(result.body);
        expect(body).toHaveProperty('message');
        expect(body.error).toBe('DB_ERROR');
        expect(mockDynamoDb.send).toHaveBeenCalledTimes(1);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXRvZG8udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNyZWF0ZS10b2RvLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQkFBMkI7QUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDO0FBQzlCLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQztBQUVyQyw2Q0FBNkM7QUFDN0MsSUFBSSxDQUFDLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQzdDLElBQUksQ0FBQyxJQUFJLENBQUMsbUNBQW1DLENBQUMsQ0FBQztBQUcvQyx1RUFBZ0U7QUFDaEUsOERBQTJEO0FBQzNELGtFQUFrRTtBQUVsRSx1QkFBdUI7QUFDdkIsTUFBTSxZQUFZLEdBQUcsbUJBQXdDLENBQUM7QUFDOUQsTUFBTSxpQkFBaUIsR0FBRywwQkFBMEQsQ0FBQztBQUVyRixRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO0lBQ2pDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxrQkFBa0I7UUFDbEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXJCLGdDQUFnQztRQUNoQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sU0FBUyxHQUFHO1FBQ2hCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25CLEtBQUssRUFBRSxXQUFXO1lBQ2xCLFdBQVcsRUFBRSxrQkFBa0I7U0FDaEMsQ0FBQztRQUNGLE9BQU8sRUFBRSxFQUFFO1FBQ1gsVUFBVSxFQUFFLE1BQU07UUFDbEIsSUFBSSxFQUFFLFFBQVE7UUFDZCxxQkFBcUIsRUFBRSxJQUFJO1FBQzNCLGNBQWMsRUFBRSxJQUFJO1FBQ3BCLGNBQWMsRUFBRTtZQUNkLFNBQVMsRUFBRSxpQkFBaUI7U0FDN0I7S0FDc0IsQ0FBQztJQUUx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O1FBRXJFLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxxQkFBTyxFQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXhDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdkMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDcEMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyRCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU2V0IHVwIGVudmlyb25tZW50IGZpcnN0XHJcbnByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnO1xyXG5wcm9jZXNzLmVudi5UQUJMRV9OQU1FID0gJ1Rlc3RUb2Rvcyc7XHJcblxyXG4vLyBNb2NrIHRoZSBEeW5hbW9EQiBhbmQgQ2xvdWRXYXRjaCB1dGlsaXRpZXNcclxuamVzdC5tb2NrKCcuLi8uLi9zcmMvbGFtYmRhL3V0aWxzL2R5bmFtb2RiJyk7XHJcbmplc3QubW9jaygnLi4vLi4vc3JjL2xhbWJkYS91dGlscy9jbG91ZHdhdGNoJyk7XHJcblxyXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBoYW5kbGVyIH0gZnJvbSAnLi4vLi4vc3JjL2xhbWJkYS9oYW5kbGVycy9jcmVhdGUtdG9kbyc7XHJcbmltcG9ydCB7IGR5bmFtb0RiIH0gZnJvbSAnLi4vLi4vc3JjL2xhbWJkYS91dGlscy9keW5hbW9kYic7XHJcbmltcG9ydCB7IHB1Ymxpc2hNZXRyaWMgfSBmcm9tICcuLi8uLi9zcmMvbGFtYmRhL3V0aWxzL2Nsb3Vkd2F0Y2gnO1xyXG5cclxuLy8gR2V0IG1vY2tlZCBpbnN0YW5jZXNcclxuY29uc3QgbW9ja0R5bmFtb0RiID0gZHluYW1vRGIgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGR5bmFtb0RiPjtcclxuY29uc3QgbW9ja1B1Ymxpc2hNZXRyaWMgPSBwdWJsaXNoTWV0cmljIGFzIGplc3QuTW9ja2VkRnVuY3Rpb248dHlwZW9mIHB1Ymxpc2hNZXRyaWM+O1xyXG5cclxuZGVzY3JpYmUoJ0NyZWF0ZVRvZG8gTGFtYmRhJywgKCkgPT4ge1xyXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgLy8gUmVzZXQgYWxsIG1vY2tzXHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICAgIFxyXG4gICAgLy8gU2V0IHVwIGRlZmF1bHQgbW9jayBiZWhhdmlvcnNcclxuICAgIG1vY2tQdWJsaXNoTWV0cmljLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IG1vY2tFdmVudCA9IHtcclxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgdGl0bGU6ICdUZXN0IHRvZG8nLFxyXG4gICAgICBkZXNjcmlwdGlvbjogJ1Rlc3QgZGVzY3JpcHRpb24nXHJcbiAgICB9KSxcclxuICAgIGhlYWRlcnM6IHt9LFxyXG4gICAgaHR0cE1ldGhvZDogJ1BPU1QnLFxyXG4gICAgcGF0aDogJy90b2RvcycsXHJcbiAgICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IG51bGwsXHJcbiAgICBwYXRoUGFyYW1ldGVyczogbnVsbCxcclxuICAgIHJlcXVlc3RDb250ZXh0OiB7XHJcbiAgICAgIHJlcXVlc3RJZDogJ3Rlc3QtcmVxdWVzdC1pZCdcclxuICAgIH1cclxuICB9IGFzIEFQSUdhdGV3YXlQcm94eUV2ZW50O1xyXG5cclxuICBpdCgnc2hvdWxkIGNyZWF0ZSBhIHRvZG8gc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgbW9ja0R5bmFtb0RiLnNlbmQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHt9KTtcclxuXHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKG1vY2tFdmVudCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDIwMSk7XHJcbiAgICBcclxuICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcclxuICAgIGNvbnNvbGUubG9nKCdSZXNwb25zZSBib2R5OicsIEpTT04uc3RyaW5naWZ5KGJvZHksIG51bGwsIDIpKTtcclxuICAgIGNvbnNvbGUubG9nKCdSZXNwb25zZSBkYXRhOicsIEpTT04uc3RyaW5naWZ5KGJvZHkuZGF0YSwgbnVsbCwgMikpO1xyXG4gICAgZXhwZWN0KGJvZHkuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgIGV4cGVjdChib2R5LmRhdGEpLnRvSGF2ZVByb3BlcnR5KCdpZCcpO1xyXG4gICAgZXhwZWN0KGJvZHkuZGF0YSkudG9IYXZlUHJvcGVydHkoJ3RvZG9JZCcpO1xyXG4gICAgZXhwZWN0KGJvZHkuZGF0YS50aXRsZSkudG9CZSgnVGVzdCB0b2RvJyk7XHJcbiAgICBleHBlY3QoYm9keS5kYXRhLmRlc2NyaXB0aW9uKS50b0JlKCdUZXN0IGRlc2NyaXB0aW9uJyk7XHJcbiAgICBleHBlY3QoYm9keS5kYXRhKS50b0hhdmVQcm9wZXJ0eSgnY3JlYXRlZEF0Jyk7XHJcblxyXG4gICAgZXhwZWN0KG1vY2tEeW5hbW9EYi5zZW5kKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XHJcbiAgICBleHBlY3QobW9ja1B1Ymxpc2hNZXRyaWMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdUb2RvQ3JlYXRlZENvdW50JywgMSk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgcmV0dXJuIDQwMCBmb3IgaW52YWxpZCBpbnB1dCcsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IGludmFsaWRFdmVudCA9IHtcclxuICAgICAgLi4ubW9ja0V2ZW50LFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHRpdGxlOiAnJyB9KSBcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihpbnZhbGlkRXZlbnQpO1xyXG5cclxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xyXG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpKS50b0hhdmVQcm9wZXJ0eSgnbWVzc2FnZScpO1xyXG4gICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkpLmVycm9yKS50b0JlKCdJTlZBTElEX1RJVExFJyk7XHJcbiAgICBcclxuICAgIGV4cGVjdChtb2NrRHluYW1vRGIuc2VuZCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIGV4cGVjdChtb2NrUHVibGlzaE1ldHJpYykubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgRHluYW1vREIgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgbW9ja0R5bmFtb0RiLnNlbmQubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignRHluYW1vREIgZXJyb3InKSk7XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihtb2NrRXZlbnQpO1xyXG5cclxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg1MDApO1xyXG4gICAgY29uc3QgYm9keSA9IEpTT04ucGFyc2UocmVzdWx0LmJvZHkpO1xyXG4gICAgZXhwZWN0KGJvZHkpLnRvSGF2ZVByb3BlcnR5KCdtZXNzYWdlJyk7XHJcbiAgICBleHBlY3QoYm9keS5lcnJvcikudG9CZSgnREJfRVJST1InKTtcclxuICAgIGV4cGVjdChtb2NrRHluYW1vRGIuc2VuZCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xyXG4gIH0pO1xyXG59KTsiXX0=